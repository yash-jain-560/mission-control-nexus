// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Agent Status and Monitoring
model Agent {
  id            String   @id  // Use provided ID directly (e.g., 'orbit-main')
  name          String
  type          String   @default("main") // 'worker', 'coordinator', 'monitor', etc.
  status        String   @default("offline") // online, offline, idle, busy, error
  tokensAvailable Int    @default(1000000)
  tokensUsed    Int      @default(0)
  
  // Health metrics
  health        Json     @default("{\"status\": \"unknown\", \"lastCheck\": null, \"metrics\": {}}")
  
  // Timestamps
  lastHeartbeat DateTime @default(now())
  lastActive    DateTime @default(now())
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  
  // Metadata
  metadata      Json     @default("{}")
  
  // Relations
  heartbeats    Heartbeat[]
  history       AgentHistory[]

  @@index([status])
  @@index([lastHeartbeat])
  @@index([lastActive])
}

// Agent Heartbeat History
model Heartbeat {
  id        String   @id @default(cuid())
  agentId   String
  timestamp DateTime @default(now())
  status    String
  health    Json     @default("{}")
  metadata  Json     @default("{}")
  tokensUsed Int     @default(0)
  tokensAvailable Int @default(0)
  
  agent     Agent    @relation(fields: [agentId], references: [id], onDelete: Cascade)
  
  @@index([agentId])
  @@index([timestamp])
}

// Agent Status Change History
model AgentHistory {
  id         String   @id @default(cuid())
  agentId    String
  changeType String   // STATUS_CHANGE, HEALTH_UPDATE, HEARTBEAT, ERROR
  fromValue  Json?
  toValue    Json?
  timestamp  DateTime @default(now())
  metadata   Json     @default("{}")
  
  agent      Agent    @relation(fields: [agentId], references: [id], onDelete: Cascade)
  
  @@index([agentId])
  @@index([timestamp])
  @@index([changeType])
}

// Kanban Tickets
model Ticket {
  id          String   @id @default(cuid())
  title       String
  description String?
  status      String   @default("Backlog") // Backlog, Assigned, InProgress, Review, Done
  priority    String   @default("MEDIUM") // LOW, MEDIUM, HIGH, URGENT, CRITICAL
  
  // Assignment
  assigneeId  String?
  reporterId  String   @default("system")
  
  // Dates
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  dueDate     DateTime?
  
  // Metadata
  tags        String[] @default([])
  metadata    Json     @default("{}")
  
  @@index([status])
  @@index([priority])
  @@index([assigneeId])
  @@index([createdAt])
}
