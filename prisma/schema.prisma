// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Agent Status and Monitoring
model Agent {
  id            String   @id  // Use provided ID directly (e.g., 'orbit-main')
  name          String
  type          String   @default("main") // 'worker', 'coordinator', 'monitor', etc.
  status        String   @default("OFFLINE") // IDLE, THINKING, WORKING, OFFLINE
  tokensAvailable Int    @default(1000000)
  tokensUsed    Int      @default(0)
  
  // Health metrics
  health        Json     @default("{\"status\": \"unknown\", \"lastCheck\": null, \"metrics\": {}}")
  
  // Status tracking with detailed transitions
  statusHistory Json     @default("[]") // Array of { status, timestamp, durationMs, reason }
  currentStatusSince DateTime @default(now()) // When current status started
  
  // Configuration
  config        Json     @default("{}") // Agent-specific configuration
  
  // Timestamps
  lastHeartbeat DateTime @default(now())
  lastActive    DateTime @default(now())
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  
  // Metadata
  metadata      Json     @default("{}")
  
  // Relations
  heartbeats    Heartbeat[]
  history       AgentHistory[]

  @@index([status])
  @@index([lastHeartbeat])
  @@index([lastActive])
}

// Agent Heartbeat History
model Heartbeat {
  id        String   @id @default(cuid())
  agentId   String
  timestamp DateTime @default(now())
  status    String
  health    Json     @default("{}")
  metadata  Json     @default("{}")
  tokensUsed Int     @default(0)
  tokensAvailable Int @default(0)

  agent     Agent    @relation(fields: [agentId], references: [id], onDelete: Cascade)

  @@index([agentId])
  @@index([timestamp])
}

// Agent Status Change History
model AgentHistory {
  id         String   @id @default(cuid())
  agentId    String
  changeType String   // STATUS_CHANGE, HEALTH_UPDATE, HEARTBEAT, ERROR
  fromValue  Json?
  toValue    Json?
  timestamp  DateTime @default(now())
  metadata   Json     @default("{}")

  agent      Agent    @relation(fields: [agentId], references: [id], onDelete: Cascade)

  @@index([agentId])
  @@index([timestamp])
  @@index([changeType])
}

// Kanban Tickets
model Ticket {
  id          String   @id @default(cuid())
  title       String
  description String?
  status      String   @default("Backlog") // Backlog, Assigned, InProgress, Review, Done
  priority    String   @default("MEDIUM") // LOW, MEDIUM, HIGH, URGENT, CRITICAL

  // Assignment
  assigneeId  String?
  reporterId  String   @default("system")

  // Token tracking for ticket
  totalInputTokens  Int      @default(0)
  totalOutputTokens Int      @default(0)

  // Dates
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  dueDate     DateTime?

  // Metadata
  tags        String[] @default([])
  metadata    Json     @default("{}")

  // Relations
  activities  Activity[]
  history     TicketHistory[]
  comments    TicketComment[]

  @@index([status])
  @@index([priority])
  @@index([assigneeId])
  @@index([createdAt])
}

// Ticket History (Status changes, assignments)
model TicketHistory {
  id          String   @id @default(cuid())
  ticketId    String
  changeType  String   // STATUS_CHANGE, ASSIGNMENT_CHANGE, PRIORITY_CHANGE, COMMENT
  fromValue   Json?
  toValue     Json?
  changedBy   String   // agentId or 'system'
  timestamp   DateTime @default(now())
  metadata    Json     @default("{}")

  ticket      Ticket   @relation(fields: [ticketId], references: [id], onDelete: Cascade)

  @@index([ticketId])
  @@index([timestamp])
  @@index([changeType])
}

// Ticket Comments
model TicketComment {
  id          String   @id @default(cuid())
  ticketId    String
  authorId    String   // agentId or 'system'
  content     String
  timestamp   DateTime @default(now())
  metadata    Json     @default("{}")

  ticket      Ticket   @relation(fields: [ticketId], references: [id], onDelete: Cascade)

  @@index([ticketId])
  @@index([timestamp])
}

// Agent Activity Log
model Activity {
  id          String   @id @default(cuid())
  agentId     String
  activityType String   // agent_turn, tool_call, completion, error, status_change, reasoning, create_ticket, update_ticket, api_call, etc.
  description String

  // Full activity details
  inputPrompt String?   // Full user input/prompt
  output      String?   // Full model output / result
  toolName    String?   // Tool used if applicable
  toolInput   Json?     // Tool input parameters
  toolOutput  Json?     // Tool output/result

  // Content Parts - Full request/response payload details
  contentParts Json?    // JSON containing { request, response, headers, metadata }

  // Token tracking
  inputTokens  Int      @default(0)
  outputTokens Int      @default(0)
  totalTokens  Int      @default(0)  // Calculated: input + output
  cacheHits    Int      @default(0)  // Cache hit count for efficiency tracking

  // API Call Details
  apiEndpoint  String?  // API endpoint path
  apiMethod    String?  // GET, POST, PUT, DELETE, etc.
  apiStatusCode Int?    // HTTP response status code

  // Timestamps
  timestamp   DateTime  @default(now())
  duration    Int       @default(0) // milliseconds

  // Context - Activity chaining
  ticketId    String?   // Link to ticket if applicable
  parentActivityId String? // For nested activities
  sessionId   String?   // Session identifier
  requestId   String?   // Request identifier
  traceId     String?   // For distributed tracing

  // Cost tracking
  costInput   Float?    // Cost for input tokens (USD)
  costOutput  Float?    // Cost for output tokens (USD)
  costTotal   Float?    // Total cost (USD)
  modelName   String?   // Model used (for cost calculation)

  // Metadata
  metadata    Json      @default("{}")

  // Relations
  ticket      Ticket?   @relation(fields: [ticketId], references: [id], onDelete: SetNull)
  parent      Activity? @relation("ActivityChain", fields: [parentActivityId], references: [id])
  children    Activity[] @relation("ActivityChain")

  @@index([agentId])
  @@index([timestamp])
  @@index([activityType])
  @@index([ticketId])
  @@index([parentActivityId])
  @@index([traceId])
  @@index([sessionId])
  @@index([requestId])
}

// Knowledge Base Files
model KnowledgeFile {
  id          String   @id @default(cuid())
  name        String
  workspaceId String   @default("root")
  workspaceName String @default("Root Workspace")
  path        String
  content     String   @db.Text
  size        Int      @default(0)
  
  // Timestamps
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  lastModified DateTime @default(now())
  
  // Metadata
  isSystemFile Boolean @default(false)
  tags        String[] @default([])
  metadata    Json     @default("{}")

  @@index([workspaceId])
  @@index([name])
  @@unique([workspaceId, name])
}
